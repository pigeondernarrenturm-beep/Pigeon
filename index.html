<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Pigeon</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 300;
        }

        .settings-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
        }

        .main-content {
            padding: 30px 20px;
        }

        .patient-input {
            margin-bottom: 30px;
            text-align: center;
        }

        .patient-input label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .patient-input input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 18px;
            text-align: center;
            transition: border-color 0.3s;
        }

        .patient-input input:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .button-grid {
            display: grid;
            gap: 15px;
            margin-bottom: 30px;
        }

        .photo-btn {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .photo-btn:active {
            transform: scale(0.98);
        }

        .photo-btn .icon {
            font-size: 24px;
        }

        .btn-uputnica {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        }

        .btn-macro {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
        }

        .btn-micro {
            background: linear-gradient(135deg, #a8e6cf 0%, #7fcdcd 100%);
        }

        .btn-drive {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .status {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .status.success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -30%);
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h3 {
            margin-bottom: 20px;
            text-align: center;
            color: #333;
        }

        .modal input, .modal textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .modal label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .modal small {
            display: block;
            margin-bottom: 15px;
            color: #666;
            font-size: 12px;
            line-height: 1.4;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .camera-modal {
            background: black;
        }

        .camera-container {
            position: relative;
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .camera-header {
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .camera-info h3 {
            margin-bottom: 5px;
        }

        .camera-settings {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .zoom-controls {
            display: flex;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            overflow: hidden;
        }

        .zoom-btn {
            background: none;
            border: none;
            color: white;
            padding: 8px 15px;
            cursor: pointer;
        }

        .zoom-btn.active {
            background: rgba(255,255,255,0.3);
        }

        .close-camera {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
        }

        .camera-view {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            padding-bottom: 140px;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
        }

        .camera-controls {
            background: rgba(0,0,0,0.8);
            padding: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1001;
        }

        .capture-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 5px solid white;
            background: rgba(255,255,255,0.3);
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            margin: 0 auto;
            touch-action: manipulation;
        }

        .capture-btn:active {
            transform: scale(0.9);
        }

        .capture-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 50%;
        }

        .flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            opacity: 0;
            pointer-events: none;
            z-index: 9999;
        }

        .drive-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
        }

        .drive-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }

        .drive-item:last-child {
            border-bottom: none;
        }

        .drive-item-name {
            font-family: monospace;
            color: #666;
        }

        .drive-item-actions {
            display: flex;
            gap: 5px;
        }

        .drive-action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .btn-view {
            background: #007bff;
            color: white;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        @media (max-width: 480px) {
            .container {
                margin: 0;
                border-radius: 0;
                min-height: 100vh;
            }

            .main-content {
                padding: 20px 15px;
            }

            .photo-btn {
                padding: 18px;
                font-size: 16px;
            }
            
            .camera-controls {
                padding: 20px;
            }
            
            .capture-btn {
                width: 70px;
                height: 70px;
            }
        }

        @media (orientation: landscape) and (max-height: 600px) {
            .camera-header {
                padding: 10px 20px;
            }
            
            .camera-view {
                padding-bottom: 100px;
            }
            
            .camera-controls {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Pigeon</h1>
            <button class="settings-btn" onclick="openSettings()">⚙️</button>
        </div>

        <div class="main-content">
            <div id="status" class="status" style="display: none;"></div>

            <div class="button-grid">
                <button class="photo-btn btn-uputnica" onclick="showPatientInput('uputnica')">
                    <span>UPUTNICA</span>
                    <span class="icon">📄</span>
                </button>

                <button class="photo-btn btn-macro" onclick="showPatientInput('macro')">
                    <span>MAKROSKOPSKA SLIKA</span>
                    <span class="icon">📷</span>
                </button>

                <button class="photo-btn btn-micro" onclick="showPatientInput('micro')">
                    <span>MIKROSKOPSKA SLIKA</span>
                    <span class="icon">🔬</span>
                </button>

                <button class="photo-btn btn-drive" onclick="openDrive()">
                    <span>DRIVE PREGLED</span>
                    <span class="icon">☁️</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Patient Input Modal -->
    <div id="patientModal" class="modal">
        <div class="modal-content">
            <h3 id="patientModalTitle">UPUTNICA</h3>
            <label for="patientNumber">Broj pacijenta:</label>
            <input type="text" id="patientNumber" placeholder="Unesite broj pacijenta..." autofocus>
            <div class="modal-buttons" id="patientModalButtons">
                <button class="modal-btn btn-primary" onclick="confirmPatientAndStartCamera()">Pokreni kameru</button>
                <button class="modal-btn btn-secondary" onclick="closePatientInput()">Odustani</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h3>Google Drive API Opcije</h3>
            
            <label for="apiKey">Google API Key:</label>
            <input type="password" id="apiKey" placeholder="AIzaSy...">
            
            <label for="clientId">Google Client ID:</label>
            <input type="text" id="clientId" placeholder="123...apps.googleusercontent.com">
            
            <label for="driveFolder">Google Drive Folder ID:</label>
            <input type="text" id="driveFolder" placeholder="1A2B3C4D5E6F7G8H9I0J...">
            
            <small>
                <strong>Kako dobiti podatke:</strong><br>
                1. Idite na <a href="https://console.cloud.google.com" target="_blank">Google Cloud Console</a><br>
                2. Napravite projekat i omogućite Drive API<br>
                3. Napravite API Key i OAuth Client ID<br>
                4. Drive Folder ID je iz URL-a: drive.google.com/drive/folders/<strong>ID_OVDJE</strong>
            </small>
            
            <div class="modal-buttons">
                <button class="modal-btn btn-primary" onclick="saveSettings()">Sačuvaj</button>
                <button class="modal-btn btn-secondary" onclick="closeSettings()">Odustani</button>
            </div>
        </div>
    </div>

    <!-- Camera Modal -->
    <div id="cameraModal" class="modal camera-modal">
        <div class="camera-container">
            <div class="camera-header">
                <div class="camera-info">
                    <h3 id="cameraTitle">UPUTNICA</h3>
                    <p>Pacijent: <span id="cameraPatient"></span></p>
                </div>
                <div class="camera-settings">
                    <div class="zoom-controls" id="zoomControls" style="display: none;">
                        <button class="zoom-btn active" onclick="setZoom('1x')">1x</button>
                        <button class="zoom-btn" onclick="setZoom('2x')">2x</button>
                    </div>
                    <button class="close-camera" onclick="closeCamera()">✕</button>
                </div>
            </div>

            <div class="camera-view">
                <video id="video" autoplay playsinline></video>
                <div class="camera-overlay" id="cameraOverlay">
                    <div id="flashIndicator" style="display: none;">⚡ Blic ON</div>
                    <div id="portraitIndicator" style="display: none;">📷 Portrait mode</div>
                    <div id="zoomIndicator">🔍 1x</div>
                </div>
            </div>

            <div class="camera-controls">
                <button class="capture-btn" onclick="capturePhoto()"></button>
            </div>
        </div>
    </div>

    <!-- Drive Modal -->
    <div id="driveModal" class="modal">
        <div class="modal-content">
            <h3>Drive slike</h3>
            <div class="drive-list" id="driveList">
                <div style="text-align: center; color: #666; padding: 20px;">
                    Nema slika u Drive-u
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn btn-primary" onclick="showDriveSearch()">Pretraži po pacijentu</button>
                <button class="modal-btn btn-secondary" onclick="closeDrive()">Zatvori</button>
            </div>
        </div>
    </div>

    <div class="flash" id="flash"></div>

    <script>
        let gapiReady = false;
        
        // Učitaj Google API skriptu dinamički
        function loadGoogleAPI() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://apis.google.com/js/api.js';
                script.async = true;
                script.defer = true;
                script.onload = () => {
                    // Daj gapi vremena da se inicijalizuje
                    setTimeout(() => {
                        gapiReady = true;
                        console.log('Google API loaded successfully');
                        resolve();
                    }, 500);
                };
                script.onerror = () => {
                    console.error('Failed to load Google API script');
                    reject(new Error('Failed to load Google API'));
                };
                document.head.appendChild(script);
            });
        }

        // Učitaj odmah
        loadGoogleAPI().catch(err => console.error('Google API load error:', err));
        
        // Google Drive API konfiguracija
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        
        // API credentials
        let API_KEY = localStorage.getItem('pigeonApiKey') || '';
        let CLIENT_ID = localStorage.getItem('pigeonClientId') || '';
        
        // Globalne varijable
        let currentPhotoType = '';
        let currentZoom = '1x';
        let stream = null;
        let savedPhotos = JSON.parse(localStorage.getItem('pigeonPhotos') || '[]');
        let driveFolderId = localStorage.getItem('pigeonDriveFolder') || '';
        let gapi;
        let googleAuth;
        let isGoogleApiLoaded = false;

        // Inicijalizacija Google API
        async function initializeGoogleAPI() {
            if (!API_KEY || !CLIENT_ID) {
                showStatus('Potrebno je postaviti Google API credentials u opcijama', 'error');
                return false;
            }

            // Čekaj da se gapi učita
            if (!gapiReady || typeof gapi === 'undefined') {
                await new Promise(resolve => {
                    const checkGapi = setInterval(() => {
                        if (gapiReady && typeof gapi !== 'undefined') {
                            clearInterval(checkGapi);
                            resolve();
                        }
                    }, 100);
                });
            }

            try {
                await new Promise((resolve) => {
                    gapi.load('client:auth2', resolve);
                });
                await initializeGapiClient();
                return true;
            } catch (error) {
                console.error('Error loading Google API:', error);
                showStatus('Greška pri učitavanju Google API', 'error');
                return false;
            }
        }

        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: API_KEY,
                    clientId: CLIENT_ID,
                    discoveryDocs: [DISCOVERY_DOC],
                    scope: SCOPES
                });

                googleAuth = gapi.auth2.getAuthInstance();
                isGoogleApiLoaded = true;
                showStatus('Google Drive API uspješno učitan', 'success');
            } catch (error) {
                console.error('Error initializing Google API:', error);
                showStatus('Greška pri inicijalizaciji Google API: ' + error.message, 'error');
            }
        }

        // Google Drive funkcije
        async function signInToGoogle() {
            if (!isGoogleApiLoaded) {
                const success = await initializeGoogleAPI();
                if (!success) return false;
            }

            try {
                if (!googleAuth.isSignedIn.get()) {
                    await googleAuth.signIn();
                }
                return true;
            } catch (error) {
                console.error('Sign in error:', error);
                showStatus('Greška pri prijavljivanju na Google: ' + error.message, 'error');
                return false;
            }
        }

        async function uploadToDrive(fileName, dataUrl) {
            const signedIn = await signInToGoogle();
            if (!signedIn) return false;

            try {
                const response = await fetch(dataUrl);
                const blob = await response.blob();

                const metadata = {
                    name: fileName + '.jpg',
                    parents: driveFolderId ? [driveFolderId] : undefined
                };

                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
                form.append('file', blob);

                const uploadResponse = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: new Headers({
                        'Authorization': 'Bearer ' + googleAuth.currentUser.get().getAuthResponse().access_token
                    }),
                    body: form
                });

                if (uploadResponse.ok) {
                    const result = await uploadResponse.json();
                    return result;
                } else {
                    throw new Error('Upload failed: ' + uploadResponse.statusText);
                }
            } catch (error) {
                console.error('Upload error:', error);
                showStatus('Greška pri upload-u na Drive: ' + error.message, 'error');
                return false;
            }
        }

        async function listDriveFiles(patientNumber) {
            const signedIn = await signInToGoogle();
            if (!signedIn) return [];

            try {
                let query = `name contains '${patientNumber}_'`;
                if (driveFolderId) {
                    query += ` and '${driveFolderId}' in parents`;
                }

                const response = await gapi.client.drive.files.list({
                    q: query,
                    fields: 'files(id,name,webViewLink,thumbnailLink)',
                    orderBy: 'name'
                });

                return response.result.files || [];
            } catch (error) {
                console.error('Error listing files:', error);
                showStatus('Greška pri pretraživanju Drive fajlova: ' + error.message, 'error');
                return [];
            }
        }

        // Inicijalizacija
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Google API if credentials exist
            if (API_KEY && CLIENT_ID) {
                initializeGoogleAPI();
            }
            
            // Enter key za patient input modal
            document.getElementById('patientNumber').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    confirmPatientAndStartCamera();
                }
            });
            
            // Scroll fix for mobile keyboards
            document.getElementById('patientNumber').addEventListener('focus', function() {
                setTimeout(() => {
                    this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300);
            });
        });

        // Settings funkcije
        function openSettings() {
            // Učitaj trenutne vrednosti
            document.getElementById('apiKey').value = API_KEY;
            document.getElementById('clientId').value = CLIENT_ID;
            document.getElementById('driveFolder').value = driveFolderId;
            document.getElementById('settingsModal').style.display = 'block';
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function saveSettings() {
            // Sada tek čuvaj vrednosti iz input polja
            API_KEY = document.getElementById('apiKey').value.trim();
            CLIENT_ID = document.getElementById('clientId').value.trim();
            driveFolderId = document.getElementById('driveFolder').value.trim();
            
            localStorage.setItem('pigeonApiKey', API_KEY);
            localStorage.setItem('pigeonClientId', CLIENT_ID);
            localStorage.setItem('pigeonDriveFolder', driveFolderId);
            
            if (API_KEY && CLIENT_ID) {
                initializeGoogleAPI();
                showStatus('Opcije sačuvane - Google Drive API je spreman', 'success');
            } else {
                showStatus('Opcije sačuvane', 'success');
            }
            
            closeSettings();
        }

        // Funkcije za patient input modal
        function showPatientInput(photoType) {
            currentPhotoType = photoType;
            const titles = {
                'uputnica': 'UPUTNICA',
                'macro': 'MAKROSKOPSKA SLIKA', 
                'micro': 'MIKROSKOPSKA SLIKA'
            };
            document.getElementById('patientModalTitle').textContent = titles[photoType];
            document.getElementById('patientNumber').value = '';
            
            // Promeni dugme tekst za fotografisanje
            const primaryBtn = document.querySelector('#patientModalButtons .btn-primary');
            primaryBtn.textContent = 'Pokreni kameru';
            
            document.getElementById('patientModal').style.display = 'block';
            
            // Focus na input field
            setTimeout(() => {
                document.getElementById('patientNumber').focus();
            }, 100);
        }

        function closePatientInput() {
            document.getElementById('patientModal').style.display = 'none';
            currentPhotoType = '';
        }

        function confirmPatientAndStartCamera() {
            const patientNumber = document.getElementById('patientNumber').value.trim();
            if (!patientNumber) {
                showStatus('Molimo unesite broj pacijenta', 'error');
                return;
            }
            closePatientInput();
            
            if (currentPhotoType === 'drive_search') {
                // Za Drive pretragu
                searchDriveForPatient(patientNumber);
            } else {
                // Za fotografisanje
                startCamera(currentPhotoType, patientNumber);
            }
        }

        async function searchDriveForPatient(patientNumber) {
            if (!API_KEY || !CLIENT_ID) {
                showLocalPhotos();
                return;
            }

            showStatus('🔍 Pretraživem Google Drive...', 'info');

            try {
                const driveFiles = await listDriveFiles(patientNumber);
                
                if (driveFiles.length > 0) {
                    showStatus(`✅ Pronađeno ${driveFiles.length} slika za pacijenta ${patientNumber} na Google Drive`, 'success');
                    displayDriveSearchResults(driveFiles);
                } else {
                    showStatus(`⚠️ Nema slika za pacijenta ${patientNumber} na Google Drive`, 'error');
                    showLocalPhotos();
                }
            } catch (error) {
                showStatus('Greška pri pretrazi: ' + error.message, 'error');
                showLocalPhotos();
            }
        }

        function showLocalPhotos() {
            const driveList = document.getElementById('driveList');
            driveList.innerHTML = '';

            if (savedPhotos.length === 0) {
                driveList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">Nema lokalnih slika</div>';
            } else {
                savedPhotos.forEach((photo, index) => {
                    const item = document.createElement('div');
                    item.className = 'drive-item';
                    
                    const uploadStatus = photo.uploaded ? '☁️ Drive' : '📱 Lokalno';
                    
                    item.innerHTML = `
                        <div>
                            <div class="drive-item-name">${photo.name}</div>
                            <div style="font-size: 12px; color: #999;">
                                ${photo.type} • ${uploadStatus} • ${new Date(photo.timestamp).toLocaleString('sr-RS')}
                            </div>
                        </div>
                        <div class="drive-item-actions">
                            <button class="drive-action-btn btn-view" onclick="viewPhoto(${index})">👁️</button>
                            <button class="drive-action-btn btn-delete" onclick="deletePhoto(${index})">🗑️</button>
                        </div>
                    `;
                    driveList.appendChild(item);
                });
            }

            document.getElementById('driveModal').style.display = 'block';
        }

        // Camera funkcije
        async function startCamera(photoType, patientNumber) {
            document.getElementById('cameraPatient').textContent = patientNumber;
            
            // Postavi naslov i settings
            const titles = {
                'uputnica': 'UPUTNICA',
                'macro': 'MAKROSKOPSKA SLIKA', 
                'micro': 'MIKROSKOPSKA SLIKA'
            };
            document.getElementById('cameraTitle').textContent = titles[photoType];

            // Pokaži zoom kontrole samo za micro
            const zoomControls = document.getElementById('zoomControls');
            if (photoType === 'micro') {
                zoomControls.style.display = 'flex';
            } else {
                zoomControls.style.display = 'none';
            }

            // Postavi indikatore
            document.getElementById('flashIndicator').style.display = photoType === 'uputnica' ? 'block' : 'none';
            document.getElementById('portraitIndicator').style.display = photoType === 'micro' ? 'block' : 'none';

            try {
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                };

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                document.getElementById('video').srcObject = stream;
                document.getElementById('cameraModal').style.display = 'block';
            } catch (error) {
                console.error('Camera error:', error);
                showStatus('Greška pri pristupu kameri: ' + error.message, 'error');
            }
        }

        function setZoom(zoom) {
            currentZoom = zoom;
            document.getElementById('zoomIndicator').textContent = `🔍 ${zoom}`;
            
            // Update zoom button states
            document.querySelectorAll('.zoom-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function closeCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            document.getElementById('cameraModal').style.display = 'none';
            currentPhotoType = '';
            currentZoom = '1x';
        }

        async function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);

            // Flash efekat za uputnicu
            if (currentPhotoType === 'uputnica') {
                const flash = document.getElementById('flash');
                flash.style.opacity = '0.8';
                setTimeout(() => {
                    flash.style.opacity = '0';
                }, 200);
            }

            // Generiši naziv fajla
            const patientNumber = document.getElementById('cameraPatient').textContent;
            const today = new Date();
            const dateStr = String(today.getDate()).padStart(2, '0') + '.' + 
                          String(today.getMonth() + 1).padStart(2, '0') + '.' + 
                          String(today.getFullYear()).slice(-2);
            
            // Debug log
            console.log('Photo type:', currentPhotoType);
            
            let fileName = `${patientNumber}_${currentPhotoType}_${dateStr}`;
            
            // Provjeri duplikate
            let counter = 1;
            let originalFileName = fileName;
            while (savedPhotos.some(photo => photo.name === fileName)) {
                counter++;
                fileName = `${originalFileName}(${counter})`;
            }

            // Sačuvaj sliku lokalno
            const photoData = {
                name: fileName,
                type: currentPhotoType,
                patient: patientNumber,
                dataUrl: canvas.toDataURL('image/jpeg', 0.9),
                timestamp: new Date().toISOString(),
                zoom: currentZoom,
                uploaded: false
            };

            savedPhotos.push(photoData);
            localStorage.setItem('pigeonPhotos', JSON.stringify(savedPhotos));
            
            // Pokušaj upload na Google Drive
            showStatus(`📸 Slika ${fileName} snimljena. Upload na Drive...`, 'info');
            
            if (API_KEY && CLIENT_ID && driveFolderId) {
                try {
                    const uploadResult = await uploadToDrive(fileName, photoData.dataUrl);
                    if (uploadResult) {
                        // Označi kao upload-ovano
                        photoData.uploaded = true;
                        photoData.driveId = uploadResult.id;
                        savedPhotos[savedPhotos.length - 1] = photoData;
                        localStorage.setItem('pigeonPhotos', JSON.stringify(savedPhotos));
                        
                        showStatus(`✅ Slika ${fileName} uspješno upload-ovana na Google Drive!`, 'success');
                    } else {
                        showStatus(`⚠️ Slika ${fileName} snimljena lokalno, ali nije upload-ovana`, 'error');
                    }
                } catch (error) {
                    showStatus(`⚠️ Upload greška: ${error.message}. Slika sačuvana lokalno.`, 'error');
                }
            } else {
                showStatus(`✅ Slika ${fileName} snimljena lokalno. Postavite Google API u opcijama za Drive upload.`, 'info');
            }

            closeCamera();
        }

        function displayDriveSearchResults(files) {
            const driveList = document.getElementById('driveList');
            driveList.innerHTML = '';

            files.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'drive-item';
                
                let fileType = 'unknown';
                if (file.name.includes('_uputnica_')) fileType = 'uputnica';
                else if (file.name.includes('_macro_')) fileType = 'makroskopska';
                else if (file.name.includes('_micro_')) fileType = 'mikroskopska';
                
                item.innerHTML = `
                    <div>
                        <div class="drive-item-name">${file.name}</div>
                        <div style="font-size: 12px; color: #999;">
                            ${fileType} • Google Drive
                        </div>
                    </div>
                    <div class="drive-item-actions">
                        <button class="drive-action-btn btn-view" onclick="window.open('${file.webViewLink}', '_blank')">👁️</button>
                    </div>
                `;
                driveList.appendChild(item);
            });

            document.getElementById('driveModal').style.display = 'block';
        }

        // Drive funkcije
        function openDrive() {
            // Direktno prikaži lokalne slike
            showLocalPhotos();
        }

        function showDriveSearch() {
            // Za Drive pretraživanje po pacijentu
            document.getElementById('patientModalTitle').textContent = 'DRIVE PRETRAŽIVANJE';
            document.getElementById('patientNumber').value = '';
            currentPhotoType = 'drive_search';
            
            // Promeni dugme tekst za Drive pretragu
            const primaryBtn = document.querySelector('#patientModalButtons .btn-primary');
            primaryBtn.textContent = 'Pretraži Drive';
            
            document.getElementById('patientModal').style.display = 'block';
            
            setTimeout(() => {
                document.getElementById('patientNumber').focus();
            }, 100);
        }

        function closeDrive() {
            document.getElementById('driveModal').style.display = 'none';
        }

        function viewPhoto(index) {
            const photo = savedPhotos[index];
            const newWindow = window.open('', '_blank');
            newWindow.document.write(`
                <html>
                    <head><title>${photo.name}</title></head>
                    <body style="margin:0;padding:20px;background:#f0f0f0;text-align:center;">
                        <h3>${photo.name}</h3>
                        <p>Tip: ${photo.type} | Pacijent: ${photo.patient} | ${photo.uploaded ? 'Upload-ovano na Drive' : 'Lokalno'}</p>
                        <img src="${photo.dataUrl}" style="max-width:100%;height:auto;border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,0.2);">
                    </body>
                </html>
            `);
        }

        function deletePhoto(index) {
            if (confirm('Da li ste sigurni da želite obrisati ovu sliku?')) {
                const photo = savedPhotos[index];
                savedPhotos.splice(index, 1);
                localStorage.setItem('pigeonPhotos', JSON.stringify(savedPhotos));
                updatePhotoCounts();
                showStatus(`🗑️ Obrisana slika: ${photo.name}`, 'success');
                openDrive(); // Refresh drive view
            }
        }

        // Utility funkcije
        function updatePhotoCounts() {
            const counts = { uputnica: 0, macro: 0, micro: 0 };
            savedPhotos.forEach(photo => {
                if (counts[photo.type] !== undefined) {
                    counts[photo.type]++;
                }
            });

            document.getElementById('count-uputnica').textContent = counts.uputnica;
            document.getElementById('count-macro').textContent = counts.macro;
            document.getElementById('count-micro').textContent = counts.micro;
        }

        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 4000);
        }

        // Sprečavanje zoom-a na telefonu
        document.addEventListener('touchmove', function (event) {
            if (event.scale !== 1) {
                event.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>